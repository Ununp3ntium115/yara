# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

YARA is a pattern-matching tool for malware researchers to identify and classify malware samples. This is the classic C implementation of YARA (note: the project is in maintenance mode as of 2024, with development focus shifting to YARA-X).

Version: 4.5.5

## Build System

YARA uses GNU Autotools (autoconf/automake) for its build system.

### Building from source

```bash
./bootstrap.sh      # Run autoreconf to generate configure script
./configure         # Configure the build with various options
make                # Build the project
make check          # Run test suite
```

Or use the convenience script:
```bash
./build.sh          # Runs bootstrap.sh, configure, and make
```

### Configure options

The configure script supports numerous options to enable/disable features:

**Modules:**
- `--enable-cuckoo` - Enable cuckoo module (requires jansson)
- `--enable-magic` - Enable magic module (requires libmagic)
- `--enable-macho` - Enable Mach-O module
- `--enable-dex` - Enable DEX (Android) module
- `--disable-dotnet` - Disable .NET module (enabled by default)
- `--enable-pb-tests` - Enable protobuf test module (requires protoc)

**Optional features:**
- `--disable-proc-scan` - Disable process scanning
- `--enable-debug` - Compile with -g option
- `--enable-gcov` - Compile with coverage flags
- `--disable-optimization` - Disable compiler optimizations
- `--enable-address-sanitizer` - Enable AddressSanitizer
- `--enable-undefined-behaviour-sanitizer` - Enable UBSan
- `--enable-profiling` - Enable rules profiling support

**Memory allocators:**
- `--with-jemalloc` - Use jemalloc
- `--with-tcmalloc` - Use tcmalloc
- `--with-mimalloc` - Use mimalloc

**Other:**
- `--without-crypto` - Disable OpenSSL support
- `--with-cpu-profiler` - Enable CPU profiling

## Architecture

### Core Components

**libyara** - The main library containing:
- **Compiler** (`libyara/compiler.c`, `libyara/grammar.y`, `libyara/lexer.l`): Parses YARA rules and compiles them into executable bytecode. Uses Bison for grammar parsing and Flex for lexical analysis.
- **Scanner** (`libyara/scanner.c`, `libyara/scan.c`): Executes compiled rules against target data (files, memory, processes).
- **Execution Engine** (`libyara/exec.c`): Interprets the bytecode generated by the compiler.
- **Pattern Matching** (`libyara/ahocorasick.c`, `libyara/re.c`): Implements Aho-Corasick algorithm for multi-pattern matching and regular expression engine.
- **Arena** (`libyara/arena.c`): Memory management system used by the compiler to store compiled data in relocatable buffers.

### Grammar Files

YARA uses three separate grammars (Bison .y files) and lexers (Flex .l files):
- `grammar.y` / `lexer.l` - Main YARA rule syntax
- `hex_grammar.y` / `hex_lexer.l` - Hexadecimal pattern syntax
- `re_grammar.y` / `re_lexer.l` - Regular expression syntax

These generate corresponding .c/.h files during build.

### Modules System

YARA has a pluggable module system (see `libyara/include/yara/modules.h`). Modules extend YARA with domain-specific functionality:

**Built-in modules** (in `libyara/modules/`):
- `pe/` - PE (Windows executables) parsing, including Authenticode signature verification
- `elf/` - ELF (Linux/Unix executables) parsing
- `dotnet/` - .NET assembly parsing
- `macho/` - Mach-O (macOS executables) parsing
- `dex/` - Android DEX file parsing
- `hash/` - Cryptographic hash functions
- `math/` - Mathematical operations
- `time/` - Time-related functions
- `string/` - String manipulation
- `console/` - Console output for debugging
- `cuckoo/` - Cuckoo sandbox integration (optional)
- `magic/` - File type identification via libmagic (optional)

To add a module, implement the required functions (module_declarations, module_load, module_unload, etc.) and add it to the MODULES list in Makefile.am.

### CLI Tools

- **yara** (`cli/yara.c`): Command-line scanner that applies compiled rules to files
- **yarac** (`cli/yarac.c`): Rule compiler that pre-compiles rules into binary format

### Process Scanning

Platform-specific process memory scanning implementations in `libyara/proc/`:
- `windows.c` - Windows process scanning
- `linux.c` - Linux process scanning
- `freebsd.c` - FreeBSD process scanning
- `openbsd.c` - OpenBSD process scanning
- `mach.c` - macOS process scanning (uses Mach kernel interface)
- `none.c` - Stub when process scanning is disabled

## Testing

Test files are in `tests/` directory. Each test is a standalone C program:
- `test-rules.c` - Main rule matching tests
- `test-pe.c` - PE module tests
- `test-elf.c` - ELF module tests
- `test-api.c` - API tests
- And many more module-specific tests

Run all tests:
```bash
make check
```

Run a single test:
```bash
./test-rules
# Or with make:
make check TESTS=test-rules
```

Tests use a simple framework defined in `tests/util.c`.

## Key Data Structures

- **YR_COMPILER**: Holds compiler state, including arena, hash tables, and current parsing context
- **YR_SCANNER**: Represents a scanning session with compiled rules
- **YR_RULES**: Compiled rules ready for scanning
- **YR_ARENA**: Memory arena system with multiple buffers for different data types (rules table, strings table, code section, etc.)
- **YR_RULE**: Individual rule definition
- **YR_STRING**: String pattern within a rule

## Compiler Pipeline

1. Lexer (Flex) tokenizes input
2. Parser (Bison) builds AST and emits bytecode to arena
3. Aho-Corasick automaton built from string patterns
4. Code optimization and fixup resolution
5. Final YR_RULES structure generated from arena

The compiler uses an arena with 12 distinct buffers (see YR_NUM_SECTIONS) for different types of compiled data.

## Important Macros and Conventions

- Module declarations use macros like `begin_declarations`, `declare_integer`, `declare_function`, etc.
- Functions in modules use `define_function` macro and must return via `return_integer`, `return_string`, etc.
- Error handling uses `FAIL_ON_ERROR` macro
- Platform-specific code controlled by preprocessor defines (USE_WINDOWS_PROC, USE_LINUX_PROC, etc.)

## Memory Management

YARA has custom memory allocators support and can use standard malloc or alternative allocators (jemalloc, tcmalloc, mimalloc) for debugging and performance tuning.

## Dependencies

Required:
- pthread library
- Math library (libm)

Optional:
- OpenSSL (for hash module and PE authenticode parsing)
- libmagic (for magic module)
- jansson (for cuckoo module)
- protobuf-c (for pb_tests module)
